<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì˜ì–´ê°•ì˜ ë²ˆì—­ê¸°</title>
  <style>
    body {
      font-family: "Noto Sans KR", sans-serif;
      background-color: #f8fafc;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      margin: 0;
      padding: 40px 0;
      height: 100%;
    }

    h1 {
      color: #2563eb;
      margin-bottom: 25px;
    }

    #recordBtn {
      background-color: #2563eb;
      color: white;
      border: 2px solid #2563eb;
      border-radius: 8px;
      padding: 12px 28px;
      font-size: 1.05rem;
      cursor: pointer;
      transition: 0.2s;
      margin-bottom: 35px;
    }

    #recordBtn:hover {
      background-color: #1e40af;
    }

    .container {
      width: 90%;
      display: flex;
      gap: 7%;
      justify-content: center;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    .box {
      width: 37%;
      height: 350px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.07);
      padding: 18px 24px;
      display: flex;
      flex-direction: column;
    }

    .title {
      color: #2563eb;
      font-weight: bold;
      font-size: 1rem;
      margin-bottom: 10px;
    }

    .text {
      flex: 1;
      font-size: 1.05rem;
      line-height: 1.7;
      color: #111;
      white-space: pre-wrap;
      overflow-y: auto;
    }

    @media (max-width: 900px) {
      .container {
        flex-direction: column;
        align-items: center;
        gap: 30px;
      }
      .box {
        width: 90%;
      }
    }
  </style>
</head>

<body>
  <h1> ì˜ì–´ê°•ì˜ ë²ˆì—­ê¸°</h1>
  <button id="recordBtn">â–¶ï¸ ë²ˆì—­ ì‹œì‘</button>

  <div class="container">
    <div class="box">
      <div class="title">ì›ë¬¸ (English)</div>
      <div id="originalText" class="text"></div>
    </div>

    <div class="box">
      <div class="title">ë²ˆì—­ (í•œêµ­ì–´)</div>
      <div id="translatedText" class="text"></div>
    </div>
  </div>
<script>
  const btn = document.getElementById('recordBtn');
  const originalBox = document.getElementById('originalText');
  const translatedBox = document.getElementById('translatedText');

  let mediaRecorder;
  let audioChunks = [];

  btn.addEventListener("click", async () => {
    // ğŸ™ ë…¹ìŒ ì‹œì‘
    if (!mediaRecorder || mediaRecorder.state === "inactive") {
      btn.textContent = "â¸ï¸ ë²ˆì—­ ì¤‘ì§€";
      btn.style.backgroundColor = "#f8fafc";
      btn.style.color = "#111";
      btn.style.borderColor = "#2563eb";

      try {
        // âœ… ë§ˆì´í¬ ì ‘ê·¼ ìš”ì²­
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        console.log("ğŸ¤ ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ íšë“ ì„±ê³µ:", stream);

        // âœ… ì§€ì›ë˜ëŠ” MIME íƒ€ì… í™•ì¸ (fallback í¬í•¨)
        let mimeType = "audio/webm";
        if (!MediaRecorder.isTypeSupported(mimeType)) mimeType = "audio/webm;codecs=opus";
        if (!MediaRecorder.isTypeSupported(mimeType)) mimeType = "audio/ogg";
        console.log("ğŸ™ ì‚¬ìš© MIME íƒ€ì…:", mimeType);

        mediaRecorder = new MediaRecorder(stream, { mimeType });
        audioChunks = [];

        mediaRecorder.ondataavailable = (e) => {
          if (e.data && e.data.size > 0) {
            audioChunks.push(e.data);
            console.log("ğŸ§ chunk ìˆ˜ì§‘ë¨:", e.data.size, "bytes");
          }
        };

        // ğŸ”¹ ì¤‘ì§€ ì‹œ ì„œë²„ë¡œ ì „ì†¡
        mediaRecorder.onstop = async () => {
          console.log("ğŸŸ¥ ë…¹ìŒ ì¤‘ì§€ë¨. ì´ chunk ê°œìˆ˜:", audioChunks.length);

          // âœ… flush ëŒ€ê¸° (ë²„í¼ ìœ ì‹¤ ë°©ì§€)
          await new Promise((resolve) => setTimeout(resolve, 300));

          // âœ… Blob ìƒì„±
          const audioBlob = new Blob(audioChunks, { type: mimeType });
          console.log("ğŸŸ¦ Blob í¬ê¸°:", audioBlob.size, "bytes");

          if (audioBlob.size < 5000) {
            originalBox.textContent = "âš ï¸ ë…¹ìŒëœ ë°ì´í„°ê°€ ë„ˆë¬´ ì§§ê±°ë‚˜ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.";
            translatedBox.textContent = "";
            btn.textContent = "â–¶ï¸ ë²ˆì—­ ì‹œì‘";
            btn.style.backgroundColor = "#2563eb";
            btn.style.color = "white";
            return;
          }

          const formData = new FormData();
          formData.append("audio", audioBlob, "speech.webm");

          originalBox.textContent = "ğŸ•“ ì¸ì‹ ì¤‘...";
          translatedBox.textContent = "";

          try {
            const res = await fetch("/translate", { method: "POST", body: formData });
            const data = await res.json();
            console.log("ğŸŸ© ì„œë²„ ì‘ë‹µ:", data);

            if (data.error) {
              originalBox.textContent = "âŒ ì˜¤ë¥˜: " + data.error;
            } else {
              originalBox.textContent = data.original;
              translatedBox.textContent = data.translated;
            }
          } catch (err) {
            originalBox.textContent = "âŒ ì„œë²„ í†µì‹  ì˜¤ë¥˜: " + err.message;
            console.error("ğŸš¨ fetch ì˜¤ë¥˜:", err);
          }

          // ë²„íŠ¼ ìƒíƒœ ë³µêµ¬
          btn.textContent = "â–¶ï¸ ë²ˆì—­ ì‹œì‘";
          btn.style.backgroundColor = "#2563eb";
          btn.style.color = "white";
        };

        // ğŸ¬ ë…¹ìŒ ì‹œì‘
        mediaRecorder.start();
        console.log("âºï¸ ë…¹ìŒ ì‹œì‘ë¨");

      } catch (err) {
        console.error("ğŸš« ë§ˆì´í¬ ì ‘ê·¼ ì‹¤íŒ¨:", err);
        originalBox.textContent = "âŒ ë§ˆì´í¬ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.";
      }
    }

    // ğŸ›‘ ë…¹ìŒ ì¤‘ì§€
    else {
      mediaRecorder.stop();
      console.log("â¹ï¸ stop() í˜¸ì¶œë¨");
    }
  });
</script>

</body>
</html>
